<!DOCTYPE html><html class="default"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="IE=edge"/><title>@zetamarkets/sdk</title><meta name="description" content="Documentation for @zetamarkets/sdk"/><meta name="viewport" content="width=device-width, initial-scale=1"/><link rel="stylesheet" href="assets/style.css"/><link rel="stylesheet" href="assets/highlight.css"/><script async src="assets/search.js" id="search-script"></script></head><body><script>document.body.classList.add(localStorage.getItem("tsd-theme") || "os")</script><header><div class="tsd-page-toolbar"><div class="container"><div class="table-wrap"><div class="table-cell" id="tsd-search" data-base="."><div class="field"><label for="tsd-search-field" class="tsd-widget search no-caption">Search</label><input type="text" id="tsd-search-field"/></div><ul class="results"><li class="state loading">Preparing search index...</li><li class="state failure">The search index is not available</li></ul><a href="index.html" class="title">@zetamarkets/sdk</a></div><div class="table-cell" id="tsd-widgets"><div id="tsd-filter"><a href="#" class="tsd-widget options no-caption" data-toggle="options">Options</a><div class="tsd-filter-group"><div class="tsd-select" id="tsd-filter-visibility"><span class="tsd-select-label">All</span><ul class="tsd-select-list"><li data-value="public">Public</li><li data-value="protected">Public/Protected</li><li data-value="private" class="selected">All</li></ul></div> <input type="checkbox" id="tsd-filter-inherited" checked/><label class="tsd-widget" for="tsd-filter-inherited">Inherited</label><input type="checkbox" id="tsd-filter-externals" checked/><label class="tsd-widget" for="tsd-filter-externals">Externals</label></div></div><a href="#" class="tsd-widget menu no-caption" data-toggle="menu">Menu</a></div></div></div></div><div class="tsd-page-title"><div class="container"><h1>@zetamarkets/sdk </h1></div></div></header><div class="container container-main"><div class="row"><div class="col-8 col-content"><div class="tsd-panel tsd-typography"><div align="center">
  <img height="120px" src="./logo.png" />

  <h1 style="margin-top: 0px">Zeta SDK ðŸ”Œ</h1>

  <p>
    <a href="https://discord.gg/dD7YREfBkR"
      ><img
        alt="Discord Chat"
        src="https://img.shields.io/discord/841556000632078378?color=blueviolet"
    /></a>
    <a href="https://opensource.org/licenses/Apache-2.0"
      ><img
        alt="License"
        src="https://img.shields.io/badge/License-Apache%202.0-blueviolet"
    /></a>
  </p>
</div>


<a href="#zeta-sdk" id="zeta-sdk" style="color: inherit; text-decoration: none;">
  <h2>Zeta SDK</h2>
</a>
<p>This is the typescript library to interact with our Zeta program smart contract.</p>
<p><a href="https://docs.zeta.markets/">Learn more about Zeta.</a></p>
<p><a href="https://devnet.zeta.markets/">Try out Zeta devnet.</a></p>

<a href="#devnet-variables" id="devnet-variables" style="color: inherit; text-decoration: none;">
  <h2>Devnet variables</h2>
</a>
<table>
<thead>
<tr>
<th>Key</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td>NETWORK_URL</td>
<td align="center"><a href="https://api.devnet.solana.com">https://api.devnet.solana.com</a></td>
</tr>
<tr>
<td>PROGRAM_ID</td>
<td align="center">BG3oRikW8d16YjUEmX3ZxHm9SiJzrGtMhsSR8aCw1Cd7</td>
</tr>
<tr>
<td>SERVER_URL</td>
<td align="center"><a href="https://dex-devnet-webserver.zeta.markets">https://dex-devnet-webserver.zeta.markets</a></td>
</tr>
</tbody></table>

<a href="#mainnet-variables" id="mainnet-variables" style="color: inherit; text-decoration: none;">
  <h2>Mainnet variables</h2>
</a>
<table>
<thead>
<tr>
<th>Key</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td>NETWORK_URL</td>
<td align="center"><a href="https://api.mainnet-beta.solana.com">https://api.mainnet-beta.solana.com</a></td>
</tr>
<tr>
<td>PROGRAM_ID</td>
<td align="center">ZETAxsqBRek56DhiGXrn75yj2NHU3aYUnxvHXpkf3aD</td>
</tr>
</tbody></table>
<p>PROGRAM_ID is subject to change based on redeployments.</p>

<a href="#context" id="context" style="color: inherit; text-decoration: none;">
  <h2>Context</h2>
</a>
<p>Zeta is a protocol that allows the trading of undercollateralized perps, futures and options on Solana, using an orderbook matching system. Zeta is available with SOL, BTC and ETH as underlying assets, with more to come!</p>
<p>Each asset corresponds to a <code>ZetaGroup</code> account. A Zeta group contains all the respective data for its markets.</p>
<p>Zeta markets use a circular buffer of expirations, as the markets are re-used after expiry.</p>
<table>
<thead>
<tr>
<th>Field</th>
<th align="center">Value</th>
</tr>
</thead>
<tbody><tr>
<td>Expiration interval</td>
<td align="center">1 Week</td>
</tr>
<tr>
<td>Number of expiries</td>
<td align="center">2</td>
</tr>
<tr>
<td>Number of strikes</td>
<td align="center">11</td>
</tr>
<tr>
<td>Supported instruments</td>
<td align="center">Call, Put, Future, Perp</td>
</tr>
</tbody></table>
<p>As such - there are 23 markets per expiry</p>
<ul>
<li>11 calls, 11 puts, 1 future</li>
</ul>
<p>We are on weekly expiries. Perps sit separate to futures and options as they do not expire, but most of your code can be reused between all products - it&#39;s just a different market index.</p>
<p>Native numbers are represented with BN to the precision of 6 d.p as u64 integers in the smart contract code.</p>
<p>They will need to be divided by 10^6 to get the decimal value.</p>
<p>Use our helper functions in <code>src/utils.ts</code> to convert.</p>
<pre><code class="language-ts"><span class="hl-0">// Asset that we wish to trade on</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">asset</span><span class="hl-2"> = </span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">BTC</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// A variable of type BN (big number)</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">balance</span><span class="hl-2">: </span><span class="hl-5">BN</span><span class="hl-2"> = </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">getMarginAccount</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">).</span><span class="hl-3">balance</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// If you had deposited $10,000 USDC</span><br/><span class="hl-3">balance</span><span class="hl-2">.</span><span class="hl-6">toNumber</span><span class="hl-2">(); </span><span class="hl-0">// == 10_000_000_000</span><br/><br/><span class="hl-0">// Convert decimal number to native fixed point.</span><br/><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertDecimalToNativeInteger</span><span class="hl-2">(</span><span class="hl-7">10_000</span><span class="hl-2">); </span><span class="hl-0">// == 10_000_000_000;</span><br/><br/><span class="hl-0">// Convert native integer to decimal.</span><br/><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertNativeIntegerToDecimal</span><span class="hl-2">(</span><span class="hl-3">balance</span><span class="hl-2">.</span><span class="hl-6">toNumber</span><span class="hl-2">()); </span><span class="hl-0">// == 10_000</span><br/><br/><span class="hl-0">// Convert native BN to decimal.</span><br/><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertNativeBNToDecimal</span><span class="hl-2">(</span><span class="hl-3">balance</span><span class="hl-2">); </span><span class="hl-0">// == 10_000</span>
</code></pre>

<a href="#install" id="install" style="color: inherit; text-decoration: none;">
  <h2>Install</h2>
</a>
<pre><code class="language-sh"><span class="hl-2">npm install @zetamarkets/sdk</span>
</code></pre>

<a href="#getting-started" id="getting-started" style="color: inherit; text-decoration: none;">
  <h2>Getting started</h2>
</a>

<a href="#setting-up-a-wallet" id="setting-up-a-wallet" style="color: inherit; text-decoration: none;">
  <h3>Setting up a wallet</h3>
</a>
<p>Before we start writing any code, we need a fresh Solana wallet - skip this if you already have your own wallet.</p>
<pre><code class="language-sh"><span class="hl-0"># Generate new keypair at ./bot-key.json</span><br/><span class="hl-2">solana-keygen new -o bot-key.json</span><br/><br/><span class="hl-0"># View new pubkey address</span><br/><span class="hl-2">solana-keygen pubkey bot-key.json</span><br/><br/><span class="hl-0"># Put private key into .env file used by script</span><br/><span class="hl-0"># (Make sure you are in the same directory as where you are running the script.)</span><br/><span class="hl-6">echo</span><span class="hl-2"> private_key=</span><span class="hl-8">`cat bot-key.json`</span><span class="hl-2"> &gt;&gt; .env</span>
</code></pre>

<a href="#env-file" id="env-file" style="color: inherit; text-decoration: none;">
  <h3>.env file</h3>
</a>
<p>At this point there will be .env file with your freshly created private key. Open it up with your favourite text editor and add the following two lines:</p>
<pre><code class="language-sh"><span class="hl-2">network_url=https://api.devnet.solana.com</span><br/><span class="hl-2">server_url=https://dex-devnet-webserver.zeta.markets</span>
</code></pre>
<p>Note that the default Solana RPC will probably rate-limit you. Now&#39;s a good time to find a better one - for starters check out Runnode, Alchemy or RPCPool.</p>

<a href="#basic-setup-boilerplate" id="basic-setup-boilerplate" style="color: inherit; text-decoration: none;">
  <h3>Basic setup boilerplate</h3>
</a>
<p>Now that you&#39;re set up, we can start loading the Zeta exchange! Start with the following code, which will set up all necessary connections, airdrop you some SOL + USDC (devnet only) and load the exchange.</p>
<pre><code class="language-ts"><span class="hl-0">// Loads the local .env file into `process.env`.</span><br/><span class="hl-6">require</span><span class="hl-2">(</span><span class="hl-8">&quot;dotenv&quot;</span><span class="hl-2">).</span><span class="hl-6">config</span><span class="hl-2">();</span><br/><br/><span class="hl-9">import</span><span class="hl-2"> { </span><span class="hl-3">Connection</span><span class="hl-2">, </span><span class="hl-3">Keypair</span><span class="hl-2"> } </span><span class="hl-9">from</span><span class="hl-2"> </span><span class="hl-8">&quot;@solana/web3.js&quot;</span><span class="hl-2">;</span><br/><span class="hl-9">import</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">Client</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">Exchange</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">Network</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">Wallet</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">utils</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">types</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">assets</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">Decimal</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">constants</span><span class="hl-2">,</span><br/><span class="hl-2">} </span><span class="hl-9">from</span><span class="hl-2"> </span><span class="hl-8">&quot;@zetamarkets/sdk&quot;</span><span class="hl-2">;</span><br/><span class="hl-9">import</span><span class="hl-2"> </span><span class="hl-3">fetch</span><span class="hl-2"> </span><span class="hl-9">from</span><span class="hl-2"> </span><span class="hl-8">&quot;node-fetch&quot;</span><span class="hl-2">;</span><br/><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">NETWORK_URL</span><span class="hl-2"> = </span><span class="hl-3">process</span><span class="hl-2">.</span><span class="hl-3">env</span><span class="hl-2">[</span><span class="hl-8">&quot;network_url&quot;</span><span class="hl-2">]!;</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">SERVER_URL</span><span class="hl-2"> = </span><span class="hl-3">process</span><span class="hl-2">.</span><span class="hl-3">env</span><span class="hl-2">[</span><span class="hl-8">&quot;server_url&quot;</span><span class="hl-2">];</span><br/><br/><span class="hl-0">// Loads the private key in .env</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">privateKey</span><span class="hl-2"> = </span><span class="hl-3">Keypair</span><span class="hl-2">.</span><span class="hl-6">fromSecretKey</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-5">Uint8Array</span><span class="hl-2">(</span><span class="hl-5">JSON</span><span class="hl-2">.</span><span class="hl-6">parse</span><span class="hl-2">(</span><span class="hl-3">Buffer</span><span class="hl-2">.</span><span class="hl-6">from</span><span class="hl-2">(</span><span class="hl-3">process</span><span class="hl-2">.</span><span class="hl-3">env</span><span class="hl-2">.</span><span class="hl-3">private_key</span><span class="hl-2">).</span><span class="hl-6">toString</span><span class="hl-2">()))</span><br/><span class="hl-2">);</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">wallet</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-6">Wallet</span><span class="hl-2">(</span><span class="hl-3">privateKey</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Starts a solana web3 connection to an RPC endpoint</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">connection</span><span class="hl-2"> = </span><span class="hl-1">new</span><span class="hl-2"> </span><span class="hl-6">Connection</span><span class="hl-2">(</span><span class="hl-3">networkUrl</span><span class="hl-2">, </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">defaultCommitment</span><span class="hl-2">());</span><br/><br/><span class="hl-0">// Airdrop some SOL to your wallet</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">connection</span><span class="hl-2">.</span><span class="hl-6">requestAirdrop</span><span class="hl-2">(</span><span class="hl-3">wallet</span><span class="hl-2">.</span><span class="hl-3">publicKey</span><span class="hl-2">, </span><span class="hl-7">100000000</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// USDC faucet - Mint $10,000 USDC (Note USDC is fake on devnet)</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-6">fetch</span><span class="hl-2">(</span><span class="hl-8">`</span><span class="hl-1">${</span><span class="hl-4">SERVER_URL</span><span class="hl-1">}</span><span class="hl-8">/faucet/USDC`</span><span class="hl-2">, {</span><br/><span class="hl-2">  </span><span class="hl-3">method:</span><span class="hl-2"> </span><span class="hl-8">&quot;post&quot;</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">body:</span><span class="hl-2"> </span><span class="hl-5">JSON</span><span class="hl-2">.</span><span class="hl-6">stringify</span><span class="hl-2">({</span><br/><span class="hl-2">    </span><span class="hl-3">key:</span><span class="hl-2"> </span><span class="hl-3">wallet</span><span class="hl-2">.</span><span class="hl-3">publicKey</span><span class="hl-2">.</span><span class="hl-6">toString</span><span class="hl-2">(),</span><br/><span class="hl-2">    </span><span class="hl-3">amount:</span><span class="hl-2"> </span><span class="hl-7">10_000</span><span class="hl-2">,</span><br/><span class="hl-2">  }),</span><br/><span class="hl-2">  </span><span class="hl-3">headers:</span><span class="hl-2"> { </span><span class="hl-8">&quot;Content-Type&quot;</span><span class="hl-3">:</span><span class="hl-2"> </span><span class="hl-8">&quot;application/json&quot;</span><span class="hl-2"> },</span><br/><span class="hl-2">});</span><br/><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">loadExchangeConfig</span><span class="hl-2"> = </span><span class="hl-3">types</span><span class="hl-2">.</span><span class="hl-6">defaultLoadExchangeConfig</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">Network</span><span class="hl-2">.</span><span class="hl-4">DEVNET</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">connection</span><span class="hl-2">,</span><br/><span class="hl-2">  [</span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">SOL</span><span class="hl-2">, </span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">BTC</span><span class="hl-2">], </span><span class="hl-0">// Can be one or more depending on what you wish to trade</span><br/><span class="hl-2">  </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">defaultCommitment</span><span class="hl-2">(),</span><br/><span class="hl-2">  </span><span class="hl-7">0</span><span class="hl-2">, </span><span class="hl-0">// ThrottleMs - increase if you are running into rate limit issues on startup.</span><br/><span class="hl-2">  </span><span class="hl-1">true</span><span class="hl-2"> </span><span class="hl-0">// LoadFromStore - whether you wish to load market addresses from the static storage (faster) or fetch everything from the chain (slower)</span><br/><span class="hl-2">);</span><br/><br/><span class="hl-0">// Loads the SDK exchange singleton. This can take a few seconds...</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">load</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">loadExchangeConfig</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-1">undefined</span><span class="hl-2"> </span><span class="hl-0">// Callback - See below for more details.</span><br/><span class="hl-2">);</span>
</code></pre>

<a href="#displaying-exchange-state" id="displaying-exchange-state" style="color: inherit; text-decoration: none;">
  <h3>Displaying exchange state</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">// Display existing exchange state i.e. markets available and their indices.</span><br/><span class="hl-0">// Can only be run after `Exchange` is loaded.</span><br/><span class="hl-0">// This will display state for each asset consecutively</span><br/><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">displayState</span><span class="hl-2">();</span><br/><br/><span class="hl-8">`</span><br/><span class="hl-8">[EXCHANGE SOL] Display market state...</span><br/><span class="hl-8">Expiration @ Thu Nov 18 2021 08:00:00 GMT+0800</span><br/><span class="hl-8">[MARKET] INDEX: 23 KIND: call STRIKE: 220</span><br/><span class="hl-8">[MARKET] INDEX: 24 KIND: call STRIKE: 223</span><br/><span class="hl-8">[MARKET] INDEX: 25 KIND: call STRIKE: 226</span><br/><span class="hl-8">// ... Deleted for space ...</span><br/><span class="hl-8">[MARKET] INDEX: 44 KIND: put STRIKE: 260</span><br/><span class="hl-8">[MARKET] INDEX: 45 KIND: future STRIKE: 0</span><br/><span class="hl-8">Expiration @ Fri Nov 19 2021 08:00:00 GMT+0800</span><br/><span class="hl-8">[MARKET] INDEX: 0 KIND: call STRIKE: 205</span><br/><span class="hl-8">[MARKET] INDEX: 1 KIND: call STRIKE: 208</span><br/><span class="hl-8">[MARKET] INDEX: 2 KIND: call STRIKE: 211</span><br/><span class="hl-8">// ... Deleted for space ...</span><br/><span class="hl-8">[MARKET] INDEX: 20 KIND: put STRIKE: 240</span><br/><span class="hl-8">[MARKET] INDEX: 21 KIND: put STRIKE: 245</span><br/><span class="hl-8">[MARKET] INDEX: 22 KIND: future STRIKE: 0</span><br/><span class="hl-8">[MARKET] INDEX: 137 KIND: perp MARK_PRICE 15.236</span><br/><span class="hl-8">`</span><span class="hl-2">;</span>
</code></pre>
<p>Note our markets are identified by index - in a circular buffer fashion for expiries.</p>

<a href="#user-margin-accounts" id="user-margin-accounts" style="color: inherit; text-decoration: none;">
  <h3>User margin accounts</h3>
</a>
<p>A user&#39;s state is represented by a <code>MarginAccount</code> in the Zeta program. This is per asset per user.</p>
<p>It stores all the state related to a user&#39;s balance, open orders and positions.</p>
<p>Creation is baked into the <code>deposit</code> function if you don&#39;t have one already.</p>
<pre><code class="language-ts"><span class="hl-0">// Load the user SDK client.</span><br/><span class="hl-0">// Note that this client is active for the same assets you passed into Exchange.load() earlier</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">client</span><span class="hl-2"> = </span><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">Client</span><span class="hl-2">.</span><span class="hl-6">load</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">connection</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">wallet</span><span class="hl-2">, </span><span class="hl-0">// Use the loaded wallet.</span><br/><span class="hl-2">  </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">defaultCommitment</span><span class="hl-2">(),</span><br/><span class="hl-2">  </span><span class="hl-1">undefined</span><span class="hl-2"> </span><span class="hl-0">// Callback - See below for more details.</span><br/><span class="hl-2">);</span><br/><br/><span class="hl-0">// This will create a MarginAccount on first deposit.</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">deposit</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertDecimalToNativeInteger</span><span class="hl-2">(</span><span class="hl-7">10_000</span><span class="hl-2">));</span><br/><br/><span class="hl-0">// This will move funds from a BTC MarginAccount to a SOL MarginAccount, provided that you have both</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">migrateFunds</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertDecimalToNativeInteger</span><span class="hl-2">(</span><span class="hl-7">10_000</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">BTC</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">SOL</span><br/><span class="hl-2">);</span>
</code></pre>
<p>Structure</p>
<pre><code class="language-ts"><span class="hl-0">// client.getMarginAccount(asset)</span><br/><span class="hl-9">export</span><span class="hl-2"> </span><span class="hl-1">interface</span><span class="hl-2"> </span><span class="hl-5">MarginAccount</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">authority</span><span class="hl-2">: </span><span class="hl-5">PublicKey</span><span class="hl-2">; </span><span class="hl-0">// Wallet publickey.</span><br/><span class="hl-2">  </span><span class="hl-3">nonce</span><span class="hl-2">: </span><span class="hl-5">number</span><span class="hl-2">; </span><span class="hl-0">// Margin account PDA nonce.</span><br/><span class="hl-2">  </span><span class="hl-3">balance</span><span class="hl-2">: </span><span class="hl-5">anchor</span><span class="hl-2">.</span><span class="hl-5">BN</span><span class="hl-2">; </span><span class="hl-0">// Balance - doesn&#39;t take into account unrealized pnl.</span><br/><span class="hl-2">  </span><span class="hl-3">forceCancelFlag</span><span class="hl-2">: </span><span class="hl-5">boolean</span><span class="hl-2">; </span><span class="hl-0">// If you are underwater, liquidators can cancel your open orders in consecutive transactions.</span><br/><br/><span class="hl-2">  </span><span class="hl-3">openOrdersNonce</span><span class="hl-2">: </span><span class="hl-5">Array</span><span class="hl-2">&lt;</span><span class="hl-5">number</span><span class="hl-2">&gt;; </span><span class="hl-0">// Open orders account PDA nonce.</span><br/><span class="hl-2">  </span><span class="hl-3">seriesExpiry</span><span class="hl-2">: </span><span class="hl-5">Array</span><span class="hl-2">&lt;</span><span class="hl-5">anchor</span><span class="hl-2">.</span><span class="hl-5">BN</span><span class="hl-2">&gt;; </span><span class="hl-0">// Expiry timestamp for your orders and positions (used for settlement)</span><br/><br/><span class="hl-2">  </span><span class="hl-3">productLedgers</span><span class="hl-2">: </span><span class="hl-5">Array</span><span class="hl-2">&lt;</span><span class="hl-5">ProductLedger</span><span class="hl-2">&gt;; </span><span class="hl-0">// Vector of your positions and open order state.</span><br/><span class="hl-2">  </span><span class="hl-3">_productLedgersPadding</span><span class="hl-2">: </span><span class="hl-5">Array</span><span class="hl-2">&lt;</span><span class="hl-5">ProductLedger</span><span class="hl-2">&gt;;</span><br/><span class="hl-2">  </span><span class="hl-3">perpProductLedger</span><span class="hl-2">: </span><span class="hl-5">ProductLedger</span><span class="hl-2">; </span><span class="hl-0">// Perps are held separately as they do not expire</span><br/><span class="hl-2">  </span><span class="hl-3">rebalanceAmount</span><span class="hl-2">: </span><span class="hl-5">anchor</span><span class="hl-2">.</span><span class="hl-5">BN</span><span class="hl-2">; </span><span class="hl-0">// Any balance to be changed in the next market crank</span><br/><span class="hl-2">  </span><span class="hl-3">asset</span><span class="hl-2">: </span><span class="hl-5">any</span><span class="hl-2">; </span><span class="hl-0">// Underlying asset (SOL, BTC, etc.)</span><br/><br/><span class="hl-2">  </span><span class="hl-3">accountType</span><span class="hl-2">: </span><span class="hl-5">any</span><span class="hl-2">; </span><span class="hl-0">// Specific flag for whitelisted market maker accounts</span><br/><span class="hl-2">  </span><span class="hl-3">lastFundingDelta</span><span class="hl-2">: </span><span class="hl-5">AnchorDecimal</span><span class="hl-2">; </span><span class="hl-0">// The last funding rate delta applied to this account</span><br/><span class="hl-2">  </span><span class="hl-3">delegatedPubkey</span><span class="hl-2">: </span><span class="hl-5">PublicKey</span><span class="hl-2">; </span><span class="hl-0">// A public key that can perform trading functions on your behalf, set with the editDelegatedPubkey instruction</span><br/><br/><span class="hl-2">  </span><span class="hl-3">_padding</span><span class="hl-2">: </span><span class="hl-5">Array</span><span class="hl-2">&lt;</span><span class="hl-5">number</span><span class="hl-2">&gt;;</span><br/><span class="hl-2">}</span>
</code></pre>
<p>The details should be abstracted away into <code>client.getOrders(asset)</code> and <code>client.getMarginPositions(asset)</code> in the SDK.</p>

<a href="#basic-script-setup-to-place-a-trade-and-view-positions" id="basic-script-setup-to-place-a-trade-and-view-positions" style="color: inherit; text-decoration: none;">
  <h3>Basic script setup to place a trade and view positions</h3>
</a>
<p>For examples sake, we want to see the orderbook for SOL market index 137, i.e. the perps. Different markets (such as options or futures) are just a different index, which we saw earlier with utils.displayState().</p>
<pre><code class="language-ts"><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">index</span><span class="hl-2"> = </span><span class="hl-3">constants</span><span class="hl-2">.</span><span class="hl-4">PERP_INDEX</span><span class="hl-2">;</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">asset</span><span class="hl-2"> = </span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">SOL</span><span class="hl-2">;</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">updateOrderbook</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">index</span><span class="hl-2">);</span><br/><span class="hl-3">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">getOrderbook</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">index</span><span class="hl-2">));</span>
</code></pre>
<pre><code class="language-ts"><span class="hl-8">`</span><br/><span class="hl-8">{</span><br/><span class="hl-8">  bids: [</span><br/><span class="hl-8">    { price: 17.71, size: 23 },</span><br/><span class="hl-8">    { price: 16.58, size: 309 },</span><br/><span class="hl-8">    { price: 15.71, size: 251 },</span><br/><span class="hl-8">    { price: 15.52, size: 8 }</span><br/><span class="hl-8">  ],</span><br/><span class="hl-8">  asks: [ { price: 19.53, size: 23 } ]</span><br/><span class="hl-8">}</span><br/><span class="hl-8">`</span><span class="hl-2">;</span>
</code></pre>

<a href="#placing-an-order" id="placing-an-order" style="color: inherit; text-decoration: none;">
  <h3>Placing an order.</h3>
</a>
<p>Placing an order on a new market (market index) will create an <code>OpenOrders</code> account. This is handled by the SDK.</p>
<ul>
<li>The minimum price is $0.0001.</li>
<li>The minimum trade tick size is 0.001.</li>
</ul>
<pre><code class="language-ts"><span class="hl-0">// We need to convert price to the native spl token amount (6.dp)</span><br/><span class="hl-0">// utils.convertDecimalToNativeInteger(18) == (18*10^6)</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">orderPrice</span><span class="hl-2"> = </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertDecimalToNativeInteger</span><span class="hl-2">(</span><span class="hl-7">18</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// We need to convert to our native option lot size.</span><br/><span class="hl-0">// utils.convertDecimalToNativeLotSize(1) == (1*10^3)</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">orderLots</span><span class="hl-2"> = </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertDecimalToNativeLotSize</span><span class="hl-2">(</span><span class="hl-7">1</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Underlying asset that we are trading on, eg SOL or BTC</span><br/><span class="hl-1">const</span><span class="hl-2"> </span><span class="hl-4">asset</span><span class="hl-2"> = </span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">SOL</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// Place a bid order.</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">placeOrder</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">asset</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">index</span><span class="hl-2">, </span><span class="hl-0">// Either market index or market address pubkey is fine here</span><br/><span class="hl-2">  </span><span class="hl-3">orderPrice</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">orderLots</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">types</span><span class="hl-2">.</span><span class="hl-3">Side</span><span class="hl-2">.</span><span class="hl-4">BID</span><br/><span class="hl-2">);</span>
</code></pre>

<a href="#see-client-order" id="see-client-order" style="color: inherit; text-decoration: none;">
  <h3>See client order.</h3>
</a>
<p>Now that our order is placed we should see it on the orderbook. Either check in the SDK or navigate to <a href="https://devnet.zeta.markets/">https://devnet.zeta.markets/</a> to see it visually.</p>
<pre><code class="language-ts"><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">updateState</span><span class="hl-2">();</span><br/><span class="hl-3">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">getOrders</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">));</span><br/><br/><span class="hl-0">// `client.getOrders` is a list of orders in market index order.</span><br/><span class="hl-8">`</span><br/><span class="hl-8">[</span><br/><span class="hl-8">  {</span><br/><span class="hl-8">    marketIndex: 137,</span><br/><span class="hl-8">    market: PublicKey {</span><br/><span class="hl-8">      _bn: &lt;BN: 94cce37bd47128c757766685f012cac541a534ba9ed59e6bf05cd004eae1ae5&gt;</span><br/><span class="hl-8">    },    // This is the market address represented as a PublicKey</span><br/><span class="hl-8">    price: 18,</span><br/><span class="hl-8">    size: 1,</span><br/><span class="hl-8">    side: 0, // 0 for bids, 1 for asks</span><br/><span class="hl-8">    orderId: &lt;BN: 7a1200fffffffffffdfdc2&gt;, // This is used to cancel.</span><br/><span class="hl-8">    owner: PublicKey {</span><br/><span class="hl-8">      _bn: &lt;BN: 153d79e2816b07fb2388abb9bd6feb64a481f422c5ff390ad8346eb70f09111d&gt;</span><br/><span class="hl-8">    }</span><br/><span class="hl-8">  }</span><br/><span class="hl-8">]</span><br/><span class="hl-8">`</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// See our new order on the orderbook.</span><br/><span class="hl-3">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">getOrderbook</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">index</span><span class="hl-2">));</span><br/><span class="hl-8">`</span><br/><span class="hl-8">{</span><br/><span class="hl-8">  bids: [</span><br/><span class="hl-8">    { price: 18, size: 1 }, // This is our order</span><br/><span class="hl-8">    { price: 17.99, size: 23 },</span><br/><span class="hl-8">    { price: 16.58, size: 309 },</span><br/><span class="hl-8">    { price: 15.71, size: 251 },</span><br/><span class="hl-8">    { price: 15.52, size: 8 }</span><br/><span class="hl-8">  ],</span><br/><span class="hl-8">  asks: [ { price: 19.53, size: 23 } ]</span><br/><span class="hl-8">}</span><br/><span class="hl-8">`</span><span class="hl-2">;</span>
</code></pre>

<a href="#place-bid-order-in-cross-to-get-a-position" id="place-bid-order-in-cross-to-get-a-position" style="color: inherit; text-decoration: none;">
  <h3>Place bid order in cross to get a position</h3>
</a>
<p>Let&#39;s trade! Instead of just placing a resting order, send a bid order with a higher price to cross the orderbook and execute a trade.</p>
<pre><code class="language-ts"><span class="hl-0">// Place an order in cross with offers to get a position.</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">placeOrder</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">asset</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">index</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">utils</span><span class="hl-2">.</span><span class="hl-6">convertDecimalToNativeInteger</span><span class="hl-2">(</span><span class="hl-7">10</span><span class="hl-2">),</span><br/><span class="hl-2">  </span><span class="hl-3">orderLots</span><span class="hl-2">,</span><br/><span class="hl-2">  </span><span class="hl-3">types</span><span class="hl-2">.</span><span class="hl-3">Side</span><span class="hl-2">.</span><span class="hl-4">BID</span><br/><span class="hl-2">);</span><br/><br/><span class="hl-0">// View our position</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">updateState</span><span class="hl-2">();</span><br/><span class="hl-3">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">getMarginPositions</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">));</span><br/><br/><span class="hl-0">// `client.getMarginPositions` is a list of marginAccount positions in market index order.</span><br/><span class="hl-8">`</span><br/><span class="hl-8">[</span><br/><span class="hl-8">  {</span><br/><span class="hl-8">    marketIndex: 137,</span><br/><span class="hl-8">    market: PublicKey {</span><br/><span class="hl-8">      _bn: &lt;BN: 94cce37bd47128c757766685f012cac541a534ba9ed59e6bf05cd004eae1ae5&gt;</span><br/><span class="hl-8">    },</span><br/><span class="hl-8">    position: 1,</span><br/><span class="hl-8">    costOfTrades: 19.53 // 6 d.p, so $19.53</span><br/><span class="hl-8">  }</span><br/><span class="hl-8">]</span><br/><span class="hl-8">`</span><span class="hl-2">;</span>
</code></pre>
<p>We have a position of 1, with cost of trades 9530000 / 10^6 = $19.53.</p>

<a href="#cancel-order" id="cancel-order" style="color: inherit; text-decoration: none;">
  <h3>Cancel order.</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">// We only have one order at the moment.</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">order</span><span class="hl-2"> = </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">getOrders</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">)[</span><span class="hl-7">0</span><span class="hl-2">];</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">cancelOrder</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">order</span><span class="hl-2">.</span><span class="hl-3">market</span><span class="hl-2">, </span><span class="hl-3">order</span><span class="hl-2">.</span><span class="hl-3">orderId</span><span class="hl-2">, </span><span class="hl-3">order</span><span class="hl-2">.</span><span class="hl-3">side</span><span class="hl-2">);</span>
</code></pre>

<a href="#cancel-all-orders" id="cancel-all-orders" style="color: inherit; text-decoration: none;">
  <h3>Cancel all orders.</h3>
</a>
<pre><code class="language-ts"><span class="hl-0">// Optionally can pass in the asset here but we&#39;ll choose not to</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">cancelAllOrders</span><span class="hl-2">();</span>
</code></pre>
<p>See <code>src/client.ts</code> for full functionality.</p>

<a href="#check-market-mark-price" id="check-market-mark-price" style="color: inherit; text-decoration: none;">
  <h3>Check market mark price</h3>
</a>
<p>This is the price that position is marked to - (This is calculated by our on-chain Black Scholes pricing that is constantly being cranked)</p>
<pre><code class="language-ts"><span class="hl-0">// Use the market index you wish to check.</span><br/><span class="hl-3">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">getMarkPrice</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-7">2</span><span class="hl-2">));</span><br/><span class="hl-0">// The fair price of this option is $8.202024.</span><br/><span class="hl-8">`8.202024`</span><span class="hl-2">;</span>
</code></pre>

<a href="#calculate-user-margin-account-state" id="calculate-user-margin-account-state" style="color: inherit; text-decoration: none;">
  <h3>Calculate user margin account state</h3>
</a>
<p>At any point you can view your account state without having to dig through the account definitions yourself, using the <code>riskCalculator</code>.</p>
<pre><code class="language-ts"><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">marginAccountState</span><span class="hl-2"> = </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-3">riskCalculator</span><span class="hl-2">.</span><span class="hl-6">getMarginAccountState</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">getMarginAccount</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">)</span><br/><span class="hl-2">);</span><br/><span class="hl-3">console</span><span class="hl-2">.</span><span class="hl-6">log</span><span class="hl-2">(</span><span class="hl-3">marginAccountState</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// These values have all been normalized (converted from 6 dp fixed point integer to decimal)</span><br/><span class="hl-8">`</span><br/><span class="hl-8">{</span><br/><span class="hl-8">  balance: 10000,                            // Deposited $10,000</span><br/><span class="hl-8">  initialMargin: 8.202024,                   // Initial margin, from the 1 open order</span><br/><span class="hl-8">  initialMarginSkipConcession: 8.202024,     // Initial margin, from the 1 open order (if skipping concession)          </span><br/><span class="hl-8">  maintenanceMargin: 8.202024,               // Maintenance margin, from the 1 position</span><br/><span class="hl-8">  unrealizedPnl: -1.3279759999999996,        // Unrealized pnl, marked to mark price</span><br/><span class="hl-8">  unpaidFunding: 0.013,                      // Funding payments that haven&#39;t been applied to the balance yet</span><br/><span class="hl-8">  availableBalanceInitial: 9990.483,         // Equity available for trading</span><br/><span class="hl-8">  availableBalanceMaintenance: 9990.483,</span><br/><span class="hl-8">  availableBalanceWithdrawable: 9990.483</span><br/><span class="hl-8">}</span><br/><span class="hl-8">`</span><span class="hl-2">;</span>
</code></pre>

<a href="#priority-fees" id="priority-fees" style="color: inherit; text-decoration: none;">
  <h3>Priority Fees</h3>
</a>
<p>Additional priority fees can be set to maximise your transaction&#39;s chance of success. The units are microlamports per Compute Unit.</p>
<pre><code class="language-ts"><span class="hl-0">// Exchange.load() needs to be called first</span><br/><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">fee</span><span class="hl-2"> = </span><span class="hl-7">300</span><span class="hl-2">; </span><span class="hl-0">// microlamports per CU</span><br/><br/><span class="hl-0">// turn on priority fees for the first time</span><br/><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">toggleUsePriorityFees</span><span class="hl-2">(</span><span class="hl-3">fee</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// update priority fee amount</span><br/><span class="hl-3">fee</span><span class="hl-2"> = </span><span class="hl-7">500</span><span class="hl-2">;</span><br/><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">updatePriorityFee</span><span class="hl-2">(</span><span class="hl-3">fee</span><span class="hl-2">);</span>
</code></pre>

<a href="#versioned-transactions" id="versioned-transactions" style="color: inherit; text-decoration: none;">
  <h3>Versioned Transactions</h3>
</a>
<p>Can&#39;t fit all the instructions you want into a single transaction? Try using Address Lookup Tables (ALTs)! By setting <code>lutAccs = utils.getZetaLutArr()</code> when calling <code>utils.processTransaction</code>, you&#39;ll utilise features from Solana&#39;s Versioned Transactions to drastically minimise the accounts you pass in, increasing how many instructions you can sandwich together.</p>
<p>A full Versioned Transactions example is available in the examples subpage.</p>

<a href="#zeta-market-data" id="zeta-market-data" style="color: inherit; text-decoration: none;">
  <h2>Zeta market data</h2>
</a>
<p>Zeta market data is available through <code>Exchange.getZetaGroupMarkets(asset)</code>, which simplifies the data in <code>Exchange.getZetaGroup(asset)</code> to be more easily understood.</p>
<p>Markets with expiries are indexed via 0..N-1 (N being 46 for now) and are grouped in <code>ExpirySeries</code>. Perps are index 137, and sit beside the dated markets.</p>
<pre><code class="language-ts"><span class="hl-0">// Whole zeta group markets object</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">zetaGroupMarkets</span><span class="hl-2"> = </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">getZetaGroupMarket</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Index directly to access a particular market.</span><br/><span class="hl-0">// Alternatively grab this using Exchange.getMarket(asset, 5);</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">market</span><span class="hl-2"> = </span><span class="hl-3">zetaGroupMarkets</span><span class="hl-2">.</span><span class="hl-3">markets</span><span class="hl-2">[</span><span class="hl-7">5</span><span class="hl-2">];</span><br/><br/><span class="hl-0">// See market data</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">strike</span><span class="hl-2"> = </span><span class="hl-3">market</span><span class="hl-2">.</span><span class="hl-3">strike</span><span class="hl-2">;</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">kind</span><span class="hl-2"> = </span><span class="hl-3">market</span><span class="hl-2">.</span><span class="hl-3">kind</span><span class="hl-2">; </span><span class="hl-0">// This is a Kind ENUM.</span><br/><br/><span class="hl-0">// Ensure you have polled to see latest state.</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">orderbook</span><span class="hl-2"> = </span><span class="hl-3">market</span><span class="hl-2">.</span><span class="hl-3">orderbook</span><span class="hl-2">;</span><br/><br/><span class="hl-0">// See expiry data of the market.</span><br/><span class="hl-0">// This contains expiry index, active timestamp, expiry ts, and whether strikes are initialized.</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">expirySeries</span><span class="hl-2"> = </span><span class="hl-3">market</span><span class="hl-2">.</span><span class="hl-3">expirySeries</span><span class="hl-2">;</span>
</code></pre>
<p>See <code>src/markets.ts</code> to see full functionality.</p>

<a href="#viewing-perp-funding-information" id="viewing-perp-funding-information" style="color: inherit; text-decoration: none;">
  <h2>Viewing perp funding information</h2>
</a>
<p>Perp markets have a unique mechanic - funding rates (<a href="https://docs.zeta.markets/zeta-protocol/zeta-infrastructure/perpetual-funding-system">Gitbook</a>). These values are stored in the Greeks account.</p>
<pre><code class="language-ts"><span class="hl-0">// Get the whole greeks account</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">greeks</span><span class="hl-2"> = </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">getGreeks</span><span class="hl-2">(</span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">BTC</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Funding rate (per day) is stored as decimal without multipliers</span><br/><span class="hl-0">// ie if funding is 5% daily, greeks store 0.05</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">fundingRate</span><span class="hl-2"> = </span><span class="hl-3">Decimal</span><span class="hl-2">.</span><span class="hl-6">fromAnchorDecimal</span><span class="hl-2">(</span><br/><span class="hl-2">  </span><span class="hl-3">greeks</span><span class="hl-2">.</span><span class="hl-3">perpLatestFundingRate</span><br/><span class="hl-2">).</span><span class="hl-6">toNumber</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// &#39;Impact&#39; midpoint used to calculate the funding rate</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">midpoint</span><span class="hl-2"> = </span><span class="hl-3">greeks</span><span class="hl-2">.</span><span class="hl-3">perpLatestMidpoint</span><span class="hl-2">.</span><span class="hl-6">toNumber</span><span class="hl-2">();</span>
</code></pre>

<a href="#viewing-oracle-price" id="viewing-oracle-price" style="color: inherit; text-decoration: none;">
  <h2>Viewing oracle price</h2>
</a>
<p>The <code>Exchange</code> object creates an oracle subscription to any assets (eg SOL/USD or BTC/USD) on load.
You can access the latest oracle prices like so:</p>
<pre><code class="language-ts"><span class="hl-0">// Get the available price feeds.</span><br/><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-3">oracle</span><span class="hl-2">.</span><span class="hl-6">getAvailablePriceFeeds</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Get the price of a given feed.</span><br/><span class="hl-1">let</span><span class="hl-2"> </span><span class="hl-3">price</span><span class="hl-2"> = </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-3">oracle</span><span class="hl-2">.</span><span class="hl-6">getPrice</span><span class="hl-2">(</span><span class="hl-3">assets</span><span class="hl-2">.</span><span class="hl-3">Asset</span><span class="hl-2">.</span><span class="hl-4">SOL</span><span class="hl-2">);</span>
</code></pre>
<p>See callbacks to update state live.</p>

<a href="#callbacks-and-state-tracking" id="callbacks-and-state-tracking" style="color: inherit; text-decoration: none;">
  <h2>Callbacks and state tracking</h2>
</a>
<p>Due to the number of changing states in the Zeta program, the SDK makes use of Solana websockets for users to receive callbacks when accounts are <strong>polled and/or changed.</strong></p>
<p>There are two categories of callbacks, one relating to user state and the other to non-user based state (program state).</p>
<p>The callback function is passed in either</p>
<ul>
<li><code>Exchange.load</code> - for non user events.</li>
<li><code>Client.load</code> - for user events.</li>
</ul>
<p>You can see these <code>EventType</code> in <code>src/events.ts</code>.</p>
<p><strong>NOTE: Some callbacks are done on poll so don&#39;t always reflect a change in state.</strong></p>
<table>
<thead>
<tr>
<th>Event</th>
<th align="center">Type</th>
<th align="center">Meaning</th>
<th align="right">Change</th>
</tr>
</thead>
<tbody><tr>
<td>EXCHANGE</td>
<td align="center">Program</td>
<td align="center">Strike initialization, market cleaning</td>
<td align="right">Exchange&#39;s zetaGroup</td>
</tr>
<tr>
<td>EXPIRY</td>
<td align="center">Program</td>
<td align="center">On option series expiration</td>
<td align="right">Exchange&#39;s markets</td>
</tr>
<tr>
<td>GREEKS</td>
<td align="center">Program</td>
<td align="center">When greeks are updated (mark prices)</td>
<td align="right">Exchange&#39;s greeks or <br> Exchange.riskCalculator</td>
</tr>
<tr>
<td>ORDERBOOK</td>
<td align="center">Program</td>
<td align="center">When an orderbook poll occurs.</td>
<td align="right">Exchange.markets</td>
</tr>
<tr>
<td>ORACLE</td>
<td align="center">Pyth oracle</td>
<td align="center">Pyth price update.</td>
<td align="right">Exchange.oracle</td>
</tr>
<tr>
<td>CLOCK</td>
<td align="center">Solana clock</td>
<td align="center">Solana clock account change.</td>
<td align="right">Exchange.clockTimestamp</td>
</tr>
<tr>
<td>TRADEV3</td>
<td align="center">User</td>
<td align="center">On user trade event.</td>
<td align="right">client.marginAccount</td>
</tr>
<tr>
<td>ORDERCOMPLETEEVENT</td>
<td align="center">User</td>
<td align="center">User order is fully filled or cancelled.</td>
<td align="right">client.marginAccount</td>
</tr>
<tr>
<td>USER</td>
<td align="center">User</td>
<td align="center">When the user&#39;s marginAccount <br> changes, which can occur on <br> inserts, cancels, trades, withdrawals, <br> deposits, settlement, liquidation, <br> force cancellations</td>
<td align="right">client.marginAccount</td>
</tr>
</tbody></table>
<p>These callbacks should eliminate the need to poll for most accounts, unless you need certainty on the state, in which case there are polling functions available in <code>Exchange</code> and <code>Client</code>.</p>
<pre><code class="language-ts"><span class="hl-0">// Generic callback function to pass into `Exchange.load` or `Client.load`.</span><br/><span class="hl-1">async</span><span class="hl-2"> </span><span class="hl-1">function</span><span class="hl-2"> </span><span class="hl-6">callback</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">: </span><span class="hl-5">assets</span><span class="hl-2">.</span><span class="hl-5">Asset</span><span class="hl-2">, </span><span class="hl-3">eventType</span><span class="hl-2">: </span><span class="hl-5">events</span><span class="hl-2">.</span><span class="hl-5">EventType</span><span class="hl-2">, </span><span class="hl-3">data</span><span class="hl-2">: </span><span class="hl-5">any</span><span class="hl-2">) {</span><br/><span class="hl-2">  </span><span class="hl-9">switch</span><span class="hl-2"> (</span><span class="hl-3">eventType</span><span class="hl-2">) {</span><br/><span class="hl-2">    </span><span class="hl-9">case</span><span class="hl-2"> </span><span class="hl-3">events</span><span class="hl-2">.</span><span class="hl-3">EventType</span><span class="hl-2">.</span><span class="hl-4">CLOCK</span><span class="hl-2">:</span><br/><span class="hl-2">      </span><span class="hl-0">// ... Handle via Exchange.clockTimestamp</span><br/><span class="hl-2">    </span><span class="hl-9">case</span><span class="hl-2"> </span><span class="hl-3">events</span><span class="hl-2">.</span><span class="hl-3">EventType</span><span class="hl-2">.&lt;</span><span class="hl-3">SomeOtherEvent</span><span class="hl-2">&gt;:</span><br/><span class="hl-2">      </span><span class="hl-9">break</span><span class="hl-2">;</span><br/><span class="hl-2">  }</span><br/><span class="hl-2">}</span>
</code></pre>
<p><code>asset</code> in each callback can potentially be <code>null</code> if the callback applies to all assets, such as clock callbacks which are common.</p>

<a href="#event-data" id="event-data" style="color: inherit; text-decoration: none;">
  <h3>Event data</h3>
</a>
<p>The function definition of a callback is
<code> (asset: assets.Asset, event: EventType, data: any) =&gt; void</code></p>
<p>Only <code>ORACLE</code> and <code>ORDERBOOK</code> events have data in them.</p>
<p>ORACLE:</p>
<pre><code class="language-ts"><span class="hl-9">export</span><span class="hl-2"> </span><span class="hl-1">interface</span><span class="hl-2"> </span><span class="hl-5">OraclePrice</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">asset</span><span class="hl-2">: </span><span class="hl-5">assets</span><span class="hl-2">.</span><span class="hl-5">Asset</span><span class="hl-2">; </span><span class="hl-0">// The feed&#39;s asset eg SOL or BTC.</span><br/><span class="hl-2">  </span><span class="hl-3">price</span><span class="hl-2">: </span><span class="hl-5">number</span><span class="hl-2">; </span><span class="hl-0">// i.e. 1000.23</span><br/><span class="hl-2">  </span><span class="hl-3">lastUpdatedTime</span><span class="hl-2">: </span><span class="hl-5">number</span><span class="hl-2">; </span><span class="hl-0">// Seconds since Linux epoch</span><br/><span class="hl-2">  </span><span class="hl-3">lastUpdatedSlot</span><span class="hl-2">: </span><span class="hl-5">bigint</span><span class="hl-2">; </span><span class="hl-0">// Blockchain slot, from Pyth</span><br/><span class="hl-2">}</span>
</code></pre>
<p>ORDERBOOK:</p>
<pre><code class="language-ts"><span class="hl-9">export</span><span class="hl-2"> </span><span class="hl-1">interface</span><span class="hl-2"> </span><span class="hl-5">OrderbookEvent</span><span class="hl-2"> {</span><br/><span class="hl-2">  </span><span class="hl-3">marketIndex</span><span class="hl-2">: </span><span class="hl-5">number</span><span class="hl-2">; </span><span class="hl-0">// The market index that was updated.</span><br/><span class="hl-2">}</span>
</code></pre>
<p>After receiving an orderbook update, you can assume <code>Exchange.getOrderbook(asset, marketIndex)</code> is the latest state.</p>

<a href="#native-polling-in-sdk" id="native-polling-in-sdk" style="color: inherit; text-decoration: none;">
  <h2>Native polling in SDK</h2>
</a>
<p>There is polling natively built into the SDK <code>Exchange</code> and <code>Client</code> objects since state relies quite heavily on websockets.</p>
<p>This was to ensure that:</p>
<ol>
<li>SDK program state would correct itself on websocket issues.</li>
<li>There was a mechanism for users to poll state on some defined interval (and get a callback when it happened, see below).</li>
</ol>

<a href="#exchange-polling" id="exchange-polling" style="color: inherit; text-decoration: none;">
  <h3>Exchange polling</h3>
</a>
<p><code>Exchange</code> has a default poll interval of <code>constants.DEFAULT_EXCHANGE_POLL_INTERVAL</code> (set to 30 seconds).</p>
<p>You can change this via setting <code>Exchange.pollInterval</code>.</p>
<p>This will poll <code>ZetaGroup</code> and zeta <code>State</code> accounts.</p>

<a href="#market-orderbook-polling" id="market-orderbook-polling" style="color: inherit; text-decoration: none;">
  <h3>Market orderbook polling</h3>
</a>
<p>Users can elect to poll markets at a certain frequency too. This has a default poll interval of <code>constants.DEFAULT_MARKET_POLL_INTERVAL</code>. (5 seconds).</p>
<p>You can change this via <code>Exchange.getZetaGroupMarkets(asset).pollInterval</code>.</p>
<p>Users have to subscribe to a market index for polling to be done on it. This is because each market requires 2 RPC requests, so polling all markets can easily hit rate limits if not on a dedicated provider.</p>
<pre><code class="language-ts"><span class="hl-0">// Subscribe to a market index.</span><br/><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">subscribeMarket</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">index</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Unsubscribe to a market index.</span><br/><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">unsubscribeMarket</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">index</span><span class="hl-2">);</span><br/><br/><span class="hl-0">// Manually poll a market index.</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">updateOrderbook</span><span class="hl-2">(</span><span class="hl-3">asset</span><span class="hl-2">, </span><span class="hl-3">index</span><span class="hl-2">);</span>
</code></pre>

<a href="#client-polling-and-throttle" id="client-polling-and-throttle" style="color: inherit; text-decoration: none;">
  <h3>Client polling and throttle</h3>
</a>
<p><code>Client</code> has a default poll interval of <code>constants.DEFAULT_CLIENT_POLL_INTERVAL</code> (set to 20 seconds).</p>
<p>You can change this via <code>client.setPollInterval(asset)</code>.</p>
<p>This is <em>almost</em> how often the SDK will call <code>await client.updateState()</code>, which is the manual way of polling user state.</p>
<p>There is a timer that on default fires every 2 seconds, checking the last poll timestamp. If time greater than client.pollInterval has elapsed or there is a pending update, it will poll.</p>
<p>Pending update refers to a margin account websocket change callback. (The SDK subscribes to user <code>MarginAccount</code> on <code>Client.load</code>.)</p>
<p>This will do multiple things (<code>client.updateState()</code>):</p>
<ol>
<li>Fetch user margin account (<code>client.getMarginAccount(asset)</code>).</li>
<li>Update user orders (this will poll the market orderbook for each market that the user has a non zero position or open orders in - <code>client.getOrders(asset)</code>).</li>
<li>Update user positions (<code>client.getPositions(asset)</code>).</li>
</ol>
<p>This timer can be modified via <code>client.setPolling(intervalSeconds)</code>.</p>
<p>Tying into this, the motivation behind this complexity is that if a user is asynchronously placing and cancelling orders across multiple markets, you may receive multiple margin account callbacks across consecutive slots.</p>
<p>If each call back polls relevant markets for the latest user order state (2 polls per market), you can easily hit rate limits.</p>
<p>If <code>throttle</code> is set to <code>true</code>, in <code>Client.load</code>, then this timer allows users to batch client polling to the next timer interval (i.e. optimistically, 5 consecutive slot updates will only trigger 1 poll).</p>
<p>Alternatively, <code>throttle</code> can be set to <code>false</code>, and <code>client.updateState</code> will be called on every margin account change and ensure you have the latest state at all times.</p>

<a href="#shutting-down" id="shutting-down" style="color: inherit; text-decoration: none;">
  <h3>Shutting down</h3>
</a>
<p>When you want to shut down or restart the client, call this to disconnect the respective websockets.</p>
<pre><code class="language-ts"><span class="hl-0">// Close exchange object.</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">Exchange</span><span class="hl-2">.</span><span class="hl-6">close</span><span class="hl-2">();</span><br/><br/><span class="hl-0">// Close client object.</span><br/><span class="hl-9">await</span><span class="hl-2"> </span><span class="hl-3">client</span><span class="hl-2">.</span><span class="hl-6">close</span><span class="hl-2">();</span>
</code></pre>

<a href="#licensing" id="licensing" style="color: inherit; text-decoration: none;">
  <h2>Licensing</h2>
</a>
<p><a href="./LICENSE">Apache 2.0</a>.</p>
</div></div><div class="col-4 col-menu menu-sticky-wrap menu-highlight"><nav class="tsd-navigation primary"><ul><li class="current"><a href="modules.html">Exports</a></li><li class=" tsd-kind-namespace"><a href="modules/assets.html">assets</a></li><li class=" tsd-kind-namespace"><a href="modules/constants.html">constants</a></li><li class=" tsd-kind-namespace"><a href="modules/errors.html">errors</a></li><li class=" tsd-kind-namespace"><a href="modules/events.html">events</a></li><li class=" tsd-kind-namespace"><a href="modules/instructions.html">instructions</a></li><li class=" tsd-kind-namespace"><a href="modules/network.html">network</a></li><li class=" tsd-kind-namespace"><a href="modules/programTypes.html">program<wbr/>Types</a></li><li class=" tsd-kind-namespace"><a href="modules/risk.html">risk</a></li><li class=" tsd-kind-namespace"><a href="modules/riskUtils.html">risk<wbr/>Utils</a></li><li class=" tsd-kind-namespace"><a href="modules/subscription.html">subscription</a></li><li class=" tsd-kind-namespace"><a href="modules/types.html">types</a></li><li class=" tsd-kind-namespace"><a href="modules/utils.html">utils</a></li></ul></nav><nav class="tsd-navigation secondary menu-sticky"><ul><li class="tsd-kind-reference"><a href="modules.html#Network" class="tsd-kind-icon">Network</a></li><li class="tsd-kind-class"><a href="classes/Client.html" class="tsd-kind-icon">Client</a></li><li class="tsd-kind-class"><a href="classes/Decimal.html" class="tsd-kind-icon">Decimal</a></li><li class="tsd-kind-class"><a href="classes/InsuranceClient.html" class="tsd-kind-icon">Insurance<wbr/>Client</a></li><li class="tsd-kind-class"><a href="classes/Market.html" class="tsd-kind-icon">Market</a></li><li class="tsd-kind-class"><a href="classes/OpenOrders.html" class="tsd-kind-icon">Open<wbr/>Orders</a></li><li class="tsd-kind-class"><a href="classes/Oracle.html" class="tsd-kind-icon">Oracle</a></li><li class="tsd-kind-class"><a href="classes/SerumMarket.html" class="tsd-kind-icon">Serum<wbr/>Market</a></li><li class="tsd-kind-class"><a href="classes/SubClient.html" class="tsd-kind-icon">Sub<wbr/>Client</a></li><li class="tsd-kind-class"><a href="classes/SubExchange.html" class="tsd-kind-icon">Sub<wbr/>Exchange</a></li><li class="tsd-kind-class tsd-is-external"><a href="classes/Wallet.html" class="tsd-kind-icon">Wallet</a></li><li class="tsd-kind-interface"><a href="interfaces/OraclePrice.html" class="tsd-kind-icon">Oracle<wbr/>Price</a></li><li class="tsd-kind-property"><a href="modules.html#idl" class="tsd-kind-icon">idl</a></li><li class="tsd-kind-variable"><a href="modules.html#Exchange" class="tsd-kind-icon">Exchange</a></li></ul></nav></div></div></div><footer class="with-border-bottom"><div class="container"><h2>Legend</h2><div class="tsd-legend-group"><ul class="tsd-legend"><li class="tsd-kind-constructor tsd-parent-kind-class"><span class="tsd-kind-icon">Constructor</span></li><li class="tsd-kind-property tsd-parent-kind-class"><span class="tsd-kind-icon">Property</span></li><li class="tsd-kind-method tsd-parent-kind-class"><span class="tsd-kind-icon">Method</span></li><li class="tsd-kind-accessor tsd-parent-kind-class"><span class="tsd-kind-icon">Accessor</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private property</span></li><li class="tsd-kind-method tsd-parent-kind-class tsd-is-private"><span class="tsd-kind-icon">Private method</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-property tsd-parent-kind-interface"><span class="tsd-kind-icon">Property</span></li></ul><ul class="tsd-legend"><li class="tsd-kind-method tsd-parent-kind-class tsd-is-static"><span class="tsd-kind-icon">Static method</span></li></ul></div><h2>Settings</h2><p>Theme <select id="theme"><option value="os">OS</option><option value="light">Light</option><option value="dark">Dark</option></select></p></div></footer><div class="container tsd-generator"><p>Generated using <a href="https://typedoc.org/" target="_blank">TypeDoc</a></p></div><div class="overlay"></div><script src="assets/main.js"></script></body></html>